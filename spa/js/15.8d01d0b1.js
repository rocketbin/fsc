(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{"074c":function(e,r,t){"use strict";t.r(r);t("8e6e"),t("8a81"),t("551c");var n=t("f3e3"),a=t.n(n),o=(t("ffc1"),t("7f7f"),t("34ef"),t("6b54"),t("a481"),t("20d6"),t("967e")),c=t.n(o),s=t("c47a"),i=t.n(s),u=(t("96cf"),t("fa84")),p=t.n(u),d=(t("7514"),t("ac6a"),t("cadf"),t("06db"),t("456d"),t("ddfa"));t("7fae");function l(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function f(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?l(Object(t),!0).forEach((function(r){i()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}var m={watch:{consumers:{handler:function(e){e.map((function(e){e.srcObject||(e.srcObject=new MediaStream([e.track.clone()]))})),console.log(e,"@change in consumers")},deep:!0},subscribes:{handler:function(e){var r=this;e.map((function(e){e.status||r.subscibePeer(e)}))},deep:!0},lastPollSyncData:{handler:function(e){var r=this;Object.keys(e).map((function(t){(e[t].media["cam-video"]||e[t].media["cam-audio"])&&(e[t].status=!1,r.subscribeTo(e[t],t))}))},deep:!0}},data:function(){return{myPeerId:this.uuidv4(),roomId:null,subscribes:[],camEncodings:[{maxBitrate:96e3,scaleResolutionDownBy:4},{maxBitrate:68e4,scaleResolutionDownBy:1}],device:null,joined:null,localCam:null,localScreen:null,recvTransport:null,sendTransport:null,camVideoProducer:null,camAudioProducer:null,screenVideoProducer:null,screenAudioProducer:null,currentActiveSpeaker:{},lastPollSyncData:{},consumers:[],pollingInterval:null}},methods:{reset:function(){window.location.href="/tables"},close:function(){this.$peerhost.post("leave",{peerId:this.myPeerId,roomId:this.roomId}).then((function(e){console.log(e.data)}))},subscribeTo:function(e,r){this.subscribes.find((function(r){return r.joinTs===e.joinTs}))||(e.peerId=r,this.subscribes.push(e))},subscibePeer:function(e){var r=this;return p()(c.a.mark((function t(){return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r.recvTransport){t.next=4;break}return t.next=3,r.createTransport("recv");case 3:r.recvTransport=t.sent;case 4:Object.keys(e.media).map((function(t){r.$peerhost.post("recv-track",{mediaTag:t,mediaPeerId:e.peerId,peerId:r.myPeerId,roomId:r.roomId,rtpCapabilities:r.device.rtpCapabilities}).then(function(){var n=p()(c.a.mark((function n(a){var o,s;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return o=a.data,n.next=3,r.recvTransport.consume(f({},o,{appData:{peerId:e.peerId,mediaTag:t}}));case 3:s=n.sent;case 4:if("connected"===r.recvTransport.connectionState){n.next=10;break}return console.log("transport connstate",r.recvTransport.connectionState),n.next=8,r.sleep(100);case 8:n.next=4;break;case 10:return n.next=12,r.resumeConsumer(s);case 12:s.on("close",(function(e){console.log("closing consumer"),alert("closing consumer")})),r.consumers.find((function(e){return e._appData.peerId===s._appData.peerId&&e._appData.mediaTag===s._appData.mediaTag}))||r.consumers.push(s);case 15:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}())}));case 5:case"end":return t.stop()}}),t)})))()},resumeConsumer:function(e){var r=this;return p()(c.a.mark((function t(){return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",r.$peerhost.post("resume-consumer",{consumerId:e.id,peerId:r.myPeerId,roomId:r.roomId}).then(function(){var r=p()(c.a.mark((function r(t){return c.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.resume();case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}()));case 1:case"end":return t.stop()}}),t)})))()},startStream:function(){var e=this;return p()(c.a.mark((function r(){return c.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:e.getDevices().then(function(){var r=p()(c.a.mark((function r(t){return c.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(e.sendTransport){r.next=10;break}return r.next=3,e.createTransport("send");case 3:return e.sendTransport=r.sent,r.next=6,e.sendTransport.produce({track:e.localCam.getVideoTracks()[0],encodings:e.camEncodings,appData:{mediaTag:"cam-video"}});case 6:return e.camVideoProducer=r.sent,r.next=9,e.sendTransport.produce({track:e.localCam.getAudioTracks()[0],appData:{mediaTag:"cam-audio"}});case 9:e.camAudioProducer=r.sent;case 10:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}());case 1:case"end":return r.stop()}}),r)})))()},getDevices:function(){var e=this;return p()(c.a.mark((function r(){return c.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!e.localCam){r.next=2;break}return r.abrupt("return");case 2:return r.prev=2,r.next=5,navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then((function(r){return e.localCam=r,r}));case 5:return r.abrupt("return",r.sent);case 8:r.prev=8,r.t0=r.catch(2),console.error("start camera error",r.t0);case 11:case"end":return r.stop()}}),r,null,[[2,8]])})))()},createTransport:function(e){var r=this;return p()(c.a.mark((function t(){var n;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=r.roomId,t.next=3,r.$peerhost.post("create-transport",{peerId:r.myPeerId,direction:e,roomId:n}).then(function(){var t=p()(c.a.mark((function t(a){var o,s;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(s=a.data.transportOptions,"recv"!==e){t.next=7;break}return t.next=4,r.device.createRecvTransport(s);case 4:o=t.sent,t.next=14;break;case 7:if("send"!==e){t.next=13;break}return t.next=10,r.device.createSendTransport(s);case 10:o=t.sent,t.next=14;break;case 13:throw new Error("bad transport 'direction': ".concat(e));case 14:return o.on("connect",function(){var t=p()(c.a.mark((function t(a,o,i){var u;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:u=a.dtlsParameters,console.log("transport is connecting at: ",e),r.$peerhost.post("connect-transport",{transportId:s.id,dtlsParameters:u,peerId:r.myPeerId,roomId:n}).then((function(r){var t=r.data.error;if(t)return err("error connecting transport",e,t),void i();o()}));case 3:case"end":return t.stop()}}),t)})));return function(e,r,n){return t.apply(this,arguments)}}()),"send"===e&&(!1,o.on("produce",function(){var e=p()(c.a.mark((function e(t,a,o){var i,u,p;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=t.kind,u=t.rtpParameters,p=t.appData,console.log("firing produce transport event",p),r.$peerhost.post("send-track",{roomId:n,peerId:r.myPeerId,transportId:s.id,kind:i,rtpParameters:u,paused:!1,appData:p}).then((function(e){var r=e.data,t=r.error,n=r.id;if(t)return err("error setting up server-side producer",t),void o();a({id:n})}));case 3:case"end":return e.stop()}}),e)})));return function(r,t,n){return e.apply(this,arguments)}}())),o.on("connectionstatechange",function(){var e=p()(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:"disconnected"===t&&r.disconnectPeer(o),console.log("transport ".concat(o.id," connectionstatechange ").concat(t));case 2:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}()),t.abrupt("return",o);case 18:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}());case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t)})))()},disconnectPeer:function(e){var r=this;console.log("disconnecting peer"),console.log(e._consumers,this.consumers,"@check transport layer"),e._consumers.forEach((function(e){console.log(e,"@track consumers");var t=r.consumers.findIndex((function(r){return e.id===r.id}));console.log(t),r.consumers.splice(t)}))},uuidv4:function(){return"111-111-1111".replace(/[018]/g,(function(){return(15&crypto.getRandomValues(new Uint8Array(1))[0]).toString(16)}))},loadDevice:function(){console.log("starting up ... my peerId is ".concat(this.myPeerId));try{this.device=new d.Device}catch(e){if("UnsupportedError"===e.name)return void console.error("browser not supported for video calls");console.error(e)}window.addEventListener("unload",(function(){return sig("leave",{},!0)}))},startSync:function(){var e=this;return p()(c.a.mark((function r(){return c.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",e.$peerhost.post("is-sync",{peerId:e.myPeerId,roomId:e.roomId}).then((function(r){var t=r.data,n=t.peers,a=t.activeSpeaker,o=t.error;if(o)return{error:o};e.currentActiveSpeaker=a;e.sortPeers(n),e.sortPeers(e.lastPollSyncData);var c=function(r){n[r]||(log("peer ".concat(r," has exited")),e.consumers.forEach((function(e){e.appData.peerId})))};for(var s in e.lastPollSyncData)c(s);return e.consumers.forEach((function(e){var r=e.appData,t=r.peerId,a=r.mediaTag;n[t].media[a]||log("peer ".concat(t," has stopped transmitting ").concat(a))})),e.lastPollSyncData=n,{}})));case 1:case"end":return r.stop()}}),r)})))()},requestRoom:function(){this.$peerhost.post("request-room").then((function(e){window.location.href="tables?table="+e.data.roomId}))},execSignalling:function(){var e=this,r=this.$route.query.table,t=this.myPeerId;this.roomId=r,this.$peerhost.post("join-peer",{roomId:r,peerId:t}).then((function(r){var t=r.data.routerRtpCapabilities;e.device.loaded||e.device.load({routerRtpCapabilities:t}).then((function(r){var t=setInterval(p()(c.a.mark((function r(){var n,a;return c.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.startSync();case 2:n=r.sent,(a=n.error)&&(clearInterval(t),console.log(a,"@error on pll"));case 5:case"end":return r.stop()}}),r)}))),3e3)}))}))},checkRoomState:function(e){this.$peerhost.post("get-room",{roomId:e}).then((function(e){console.log(e)}))},updatePeersDisplay:function(e,r){},sortPeers:function(e){return Object.entries(e).map((function(e){var r=a()(e,2),t=r[0],n=r[1];return{id:t,joinTs:n.joinTs,media:f({},n.media)}})).sort((function(e,r){return e.joinTs>r.joinTs?1:r.joinTs>e.joinTs?-1:0}))},sleep:function(e){return p()(c.a.mark((function r(){return c.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",new Promise((function(r){return setTimeout((function(){return r()}),e)})));case 1:case"end":return r.stop()}}),r)})))()}},mounted:function(){this.loadDevice(),this.$route.query.table?this.execSignalling():this.requestRoom()}},h=t("2877"),v=Object(h.a)(m,(function(){var e=this,r=e.$createElement,t=e._self._c||r;return t("q-page",[t("div",{staticStyle:{width:"100%","max-height":"100%"}},[t("q-btn",{attrs:{label:"reset"},on:{click:e.reset}}),t("q-btn",{attrs:{label:"close"},on:{click:e.close}}),t("q-btn",{attrs:{label:"send video stream"},on:{click:e.startStream}}),t("div",{staticClass:"row",staticStyle:{width:"100%"}},[e._v("\n    "+e._s(e.consumers.length)+"\n    "),t("div",{staticClass:"col-sm-10 videos "},e._l(e.consumers,(function(e,r){return t("video",{key:r,staticStyle:{width:"250px",height:"250px"},attrs:{autoplay:""},domProps:{srcObject:e.srcObject}})})),0),t("div",{staticClass:"col-sm-6"},[t("pre",{staticStyle:{"max-height":"560px",overflow:"auto"}},[e._v("          "+e._s(this.recvTransport)+"\n        ")])])])],1)])}),[],!1,null,null,null);r.default=v.exports}}]);