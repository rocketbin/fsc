(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[15],{"074c":function(e,r,t){"use strict";t.r(r);var render=function(){var e=this,r=e.$createElement,t=e._self._c||r;return t("q-page",[t("div",{staticStyle:{width:"100%","max-height":"100%"}},[t("q-btn",{attrs:{label:"reset"},on:{click:e.reset}}),t("q-btn",{attrs:{label:"close"},on:{click:e.close}}),t("q-btn",{attrs:{label:"send video stream"},on:{click:e.startStream}}),t("div",{staticClass:"row",staticStyle:{width:"100%"}},[e._v("\n    "+e._s(e.consumers.length)+"\n    "),t("div",{staticClass:"col-sm-10 videos "},e._l(e.consumers,(function(e,r){return t("video",{key:r,staticStyle:{width:"250px",height:"250px"},attrs:{autoplay:""},domProps:{srcObject:e.srcObject}})})),0),t("div",{staticClass:"col-sm-6"},[t("pre",{staticStyle:{"max-height":"560px",overflow:"auto"}},[e._v("          "+e._s(this.recvTransport)+"\n        ")])])])],1)])},n=[],a=(t("8e6e"),t("8a81"),t("551c"),t("f3e3")),c=t.n(a),o=(t("ffc1"),t("7f7f"),t("34ef"),t("6b54"),t("a481"),t("20d6"),t("967e")),s=t.n(o),i=t("c47a"),u=t.n(i),l=(t("96cf"),t("fa84")),p=t.n(l),d=(t("7514"),t("ac6a"),t("cadf"),t("06db"),t("456d"),t("ddfa"));t("7fae");function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach((function(r){u()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}var f={watch:{consumers:{handler:function handler(e){e.map((function(e){e.srcObject||(e.srcObject=new MediaStream([e.track.clone()]))})),console.log(e,"@change in consumers")},deep:!0},subscribes:{handler:function handler(e){var r=this;e.map((function(e){e.status||r.subscibePeer(e)}))},deep:!0},lastPollSyncData:{handler:function handler(e){var r=this;Object.keys(e).map((function(t){(e[t].media["cam-video"]||e[t].media["cam-audio"])&&(e[t].status=!1,r.subscribeTo(e[t],t))}))},deep:!0}},data:function data(){return{myPeerId:this.uuidv4(),roomId:null,subscribes:[],camEncodings:[{maxBitrate:96e3,scaleResolutionDownBy:4},{maxBitrate:68e4,scaleResolutionDownBy:1}],device:null,joined:null,localCam:null,localScreen:null,recvTransport:null,sendTransport:null,camVideoProducer:null,camAudioProducer:null,screenVideoProducer:null,screenAudioProducer:null,currentActiveSpeaker:{},lastPollSyncData:{},consumers:[],pollingInterval:null}},methods:{reset:function reset(){window.location.href="/tables"},close:function close(){this.$peerhost.post("leave",{peerId:this.myPeerId,roomId:this.roomId}).then((function(e){console.log(e.data)}))},subscribeTo:function subscribeTo(e,r){var t=this.subscribes.find((function(r){return r.joinTs===e.joinTs}));t||(e.peerId=r,this.subscribes.push(e))},subscibePeer:function subscibePeer(e){var r=this;return p()(s.a.mark((function _callee2(){return s.a.wrap((function _callee2$(t){while(1)switch(t.prev=t.next){case 0:if(r.recvTransport){t.next=4;break}return t.next=3,r.createTransport("recv");case 3:r.recvTransport=t.sent;case 4:Object.keys(e.media).map((function(t){r.$peerhost.post("recv-track",{mediaTag:t,mediaPeerId:e.peerId,peerId:r.myPeerId,roomId:r.roomId,rtpCapabilities:r.device.rtpCapabilities}).then(function(){var n=p()(s.a.mark((function _callee(n){var a,c,o;return s.a.wrap((function _callee$(s){while(1)switch(s.prev=s.next){case 0:return a=n.data,s.next=3,r.recvTransport.consume(_objectSpread({},a,{appData:{peerId:e.peerId,mediaTag:t}}));case 3:c=s.sent;case 4:if("connected"===r.recvTransport.connectionState){s.next=10;break}return console.log("transport connstate",r.recvTransport.connectionState),s.next=8,r.sleep(100);case 8:s.next=4;break;case 10:return s.next=12,r.resumeConsumer(c);case 12:c.on("close",(function(e){console.log("closing consumer"),alert("closing consumer")})),o=r.consumers.find((function(e){return e._appData.peerId===c._appData.peerId&&e._appData.mediaTag===c._appData.mediaTag})),o||r.consumers.push(c);case 15:case"end":return s.stop()}}),_callee)})));return function(e){return n.apply(this,arguments)}}())}));case 5:case"end":return t.stop()}}),_callee2)})))()},resumeConsumer:function resumeConsumer(e){var r=this;return p()(s.a.mark((function _callee4(){return s.a.wrap((function _callee4$(t){while(1)switch(t.prev=t.next){case 0:return t.abrupt("return",r.$peerhost.post("resume-consumer",{consumerId:e.id,peerId:r.myPeerId,roomId:r.roomId}).then(function(){var r=p()(s.a.mark((function _callee3(r){return s.a.wrap((function _callee3$(r){while(1)switch(r.prev=r.next){case 0:return r.next=2,e.resume();case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),_callee3)})));return function(e){return r.apply(this,arguments)}}()));case 1:case"end":return t.stop()}}),_callee4)})))()},startStream:function startStream(){var e=this;return p()(s.a.mark((function _callee6(){return s.a.wrap((function _callee6$(r){while(1)switch(r.prev=r.next){case 0:e.getDevices().then(function(){var r=p()(s.a.mark((function _callee5(r){return s.a.wrap((function _callee5$(r){while(1)switch(r.prev=r.next){case 0:if(e.sendTransport){r.next=10;break}return r.next=3,e.createTransport("send");case 3:return e.sendTransport=r.sent,r.next=6,e.sendTransport.produce({track:e.localCam.getVideoTracks()[0],encodings:e.camEncodings,appData:{mediaTag:"cam-video"}});case 6:return e.camVideoProducer=r.sent,r.next=9,e.sendTransport.produce({track:e.localCam.getAudioTracks()[0],appData:{mediaTag:"cam-audio"}});case 9:e.camAudioProducer=r.sent;case 10:case"end":return r.stop()}}),_callee5)})));return function(e){return r.apply(this,arguments)}}());case 1:case"end":return r.stop()}}),_callee6)})))()},getDevices:function getDevices(){var e=this;return p()(s.a.mark((function _callee7(){return s.a.wrap((function _callee7$(r){while(1)switch(r.prev=r.next){case 0:if(!e.localCam){r.next=2;break}return r.abrupt("return");case 2:return r.prev=2,r.next=5,navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then((function(r){return e.localCam=r,r}));case 5:return r.abrupt("return",r.sent);case 8:r.prev=8,r.t0=r["catch"](2),console.error("start camera error",r.t0);case 11:case"end":return r.stop()}}),_callee7,null,[[2,8]])})))()},createTransport:function createTransport(e){var r=this;return p()(s.a.mark((function _callee12(){var t;return s.a.wrap((function _callee12$(n){while(1)switch(n.prev=n.next){case 0:return t=r.roomId,n.next=3,r.$peerhost.post("create-transport",{peerId:r.myPeerId,direction:e,roomId:t}).then(function(){var n=p()(s.a.mark((function _callee11(n){var a,c,o;return s.a.wrap((function _callee11$(i){while(1)switch(i.prev=i.next){case 0:if(c=n.data.transportOptions,"recv"!==e){i.next=7;break}return i.next=4,r.device.createRecvTransport(c);case 4:a=i.sent,i.next=14;break;case 7:if("send"!==e){i.next=13;break}return i.next=10,r.device.createSendTransport(c);case 10:a=i.sent,i.next=14;break;case 13:throw new Error("bad transport 'direction': ".concat(e));case 14:return a.on("connect",function(){var n=p()(s.a.mark((function _callee8(n,a,o){var i;return s.a.wrap((function _callee8$(s){while(1)switch(s.prev=s.next){case 0:i=n.dtlsParameters,console.log("transport is connecting at: ",e),r.$peerhost.post("connect-transport",{transportId:c.id,dtlsParameters:i,peerId:r.myPeerId,roomId:t}).then((function(r){var t=r.data.error;if(t)return err("error connecting transport",e,t),void o();a()}));case 3:case"end":return s.stop()}}),_callee8)})));return function(e,r,t){return n.apply(this,arguments)}}()),"send"===e&&(o=!1,a.on("produce",function(){var e=p()(s.a.mark((function _callee9(e,n,a){var i,u,l;return s.a.wrap((function _callee9$(s){while(1)switch(s.prev=s.next){case 0:i=e.kind,u=e.rtpParameters,l=e.appData,console.log("firing produce transport event",l),r.$peerhost.post("send-track",{roomId:t,peerId:r.myPeerId,transportId:c.id,kind:i,rtpParameters:u,paused:o,appData:l}).then((function(e){var r=e.data,t=r.error,c=r.id;if(t)return err("error setting up server-side producer",t),void a();n({id:c})}));case 3:case"end":return s.stop()}}),_callee9)})));return function(r,t,n){return e.apply(this,arguments)}}())),a.on("connectionstatechange",function(){var e=p()(s.a.mark((function _callee10(e){return s.a.wrap((function _callee10$(t){while(1)switch(t.prev=t.next){case 0:"disconnected"===e&&r.disconnectPeer(a),console.log("transport ".concat(a.id," connectionstatechange ").concat(e));case 2:case"end":return t.stop()}}),_callee10)})));return function(r){return e.apply(this,arguments)}}()),i.abrupt("return",a);case 18:case"end":return i.stop()}}),_callee11)})));return function(e){return n.apply(this,arguments)}}());case 3:return n.abrupt("return",n.sent);case 4:case"end":return n.stop()}}),_callee12)})))()},disconnectPeer:function disconnectPeer(e){var r=this;console.log("disconnecting peer"),console.log(e._consumers,this.consumers,"@check transport layer"),e._consumers.forEach((function(e){console.log(e,"@track consumers");var t=r.consumers.findIndex((function(r){return e.id===r.id}));console.log(t),r.consumers.splice(t)}))},uuidv4:function uuidv4(){return"111-111-1111".replace(/[018]/g,(function(){return(15&crypto.getRandomValues(new Uint8Array(1))[0]).toString(16)}))},loadDevice:function loadDevice(){console.log("starting up ... my peerId is ".concat(this.myPeerId));try{this.device=new d["Device"]}catch(e){if("UnsupportedError"===e.name)return void console.error("browser not supported for video calls");console.error(e)}window.addEventListener("unload",(function(){return sig("leave",{},!0)}))},startSync:function startSync(){var e=this;return p()(s.a.mark((function _callee13(){return s.a.wrap((function _callee13$(r){while(1)switch(r.prev=r.next){case 0:return r.abrupt("return",e.$peerhost.post("is-sync",{peerId:e.myPeerId,roomId:e.roomId}).then((function(r){var t=r.data,n=t.peers,a=t.activeSpeaker,c=t.error;if(c)return{error:c};e.currentActiveSpeaker=a;e.sortPeers(n),e.sortPeers(e.lastPollSyncData);var o=function _loop(r){n[r]||(log("peer ".concat(r," has exited")),e.consumers.forEach((function(e){e.appData.peerId})))};for(var s in e.lastPollSyncData)o(s);return e.consumers.forEach((function(e){var r=e.appData,t=r.peerId,a=r.mediaTag;n[t].media[a]||log("peer ".concat(t," has stopped transmitting ").concat(a))})),e.lastPollSyncData=n,{}})));case 1:case"end":return r.stop()}}),_callee13)})))()},requestRoom:function requestRoom(){this.$peerhost.post("request-room").then((function(e){window.location.href="tables?table="+e.data.roomId}))},execSignalling:function execSignalling(){var e=this,r=this.$route.query.table,t=this.myPeerId;this.roomId=r,this.$peerhost.post("join-peer",{roomId:r,peerId:t}).then((function(r){var t=r.data.routerRtpCapabilities;e.device.loaded||e.device.load({routerRtpCapabilities:t}).then((function(r){var t=setInterval(p()(s.a.mark((function _callee14(){var r,n;return s.a.wrap((function _callee14$(a){while(1)switch(a.prev=a.next){case 0:return a.next=2,e.startSync();case 2:r=a.sent,n=r.error,n&&(clearInterval(t),console.log(n,"@error on pll"));case 5:case"end":return a.stop()}}),_callee14)}))),3e3)}))}))},checkRoomState:function checkRoomState(e){this.$peerhost.post("get-room",{roomId:e}).then((function(e){console.log(e)}))},updatePeersDisplay:function updatePeersDisplay(e,r){},sortPeers:function sortPeers(e){return Object.entries(e).map((function(e){var r=c()(e,2),t=r[0],n=r[1];return{id:t,joinTs:n.joinTs,media:_objectSpread({},n.media)}})).sort((function(e,r){return e.joinTs>r.joinTs?1:r.joinTs>e.joinTs?-1:0}))},sleep:function sleep(e){return p()(s.a.mark((function _callee15(){return s.a.wrap((function _callee15$(r){while(1)switch(r.prev=r.next){case 0:return r.abrupt("return",new Promise((function(r){return setTimeout((function(){return r()}),e)})));case 1:case"end":return r.stop()}}),_callee15)})))()}},mounted:function mounted(){this.loadDevice();var e=this.$route.query.table;e?this.execSignalling():this.requestRoom()}},m=f,h=t("2877"),v=Object(h["a"])(m,render,n,!1,null,null,null);r["default"]=v.exports}}]);