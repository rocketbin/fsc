(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{"40c2":function(e,r,t){"use strict";t.r(r);t("8e6e"),t("8a81"),t("551c");var n=t("f3e3"),a=t.n(n),c=(t("ffc1"),t("7f7f"),t("34ef"),t("6b54"),t("a481"),t("967e")),s=t.n(c),o=t("c47a"),i=t.n(o),u=(t("96cf"),t("fa84")),p=t.n(u),d=(t("7514"),t("ac6a"),t("cadf"),t("06db"),t("456d"),t("ddfa"));t("7fae");function l(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function f(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?l(Object(t),!0).forEach((function(r){i()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}var v={watch:{consumers:{handler:function(e){e.map((function(e){e.srcObject||(e.srcObject=new MediaStream([e.track.clone()]))})),console.log(e)},deep:!0},subscribes:{handler:function(e){var r=this;e.map((function(e){e.status||r.subscibePeer(e)}))},deep:!0},lastPollSyncData:{handler:function(e){var r=this;Object.keys(e).map((function(t){e[t].media["cam-video"]&&(e[t].status=!1,r.subscribeTo(e[t],t))}))},deep:!0}},data:function(){return{myPeerId:this.uuidv4(),subscribes:[],camEncodings:[{maxBitrate:96e3,scaleResolutionDownBy:4},{maxBitrate:68e4,scaleResolutionDownBy:1}],device:null,joined:null,localCam:null,localScreen:null,recvTransport:null,sendTransport:null,camVideoProducer:null,camAudioProducer:null,screenVideoProducer:null,screenAudioProducer:null,currentActiveSpeaker:{},lastPollSyncData:{},consumers:[],pollingInterval:null}},methods:{subscribeTo:function(e,r){this.subscribes.find((function(r){return r.joinTs===e.joinTs}))||(e.peerId=r,this.subscribes.push(e))},subscibePeer:function(e){var r=this;return p()(s.a.mark((function t(){return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r.recvTransport){t.next=4;break}return t.next=3,r.createTransport("recv");case 3:r.recvTransport=t.sent;case 4:r.$peerhost.post("recv-track",{mediaTag:"cam-video",mediaPeerId:e.peerId,peerId:r.myPeerId,rtpCapabilities:r.device.rtpCapabilities}).then(function(){var t=p()(s.a.mark((function t(n){var a,c;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=n.data,t.next=3,r.recvTransport.consume(f({},a,{appData:{peerId:e.peerId,mediaTag:"cam-video"}}));case 3:c=t.sent;case 4:if("connected"===r.recvTransport.connectionState){t.next=10;break}return console.log("  transport connstate",r.recvTransport.connectionState),t.next=8,r.sleep(100);case 8:t.next=4;break;case 10:return t.next=12,r.resumeConsumer(c);case 12:r.consumers.push(c),console.log(c,"@ ready to consume");case 14:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}());case 5:case"end":return t.stop()}}),t)})))()},resumeConsumer:function(e){var r=this;return p()(s.a.mark((function t(){return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",r.$peerhost.post("resume-consumer",{consumerId:e.id,peerId:r.myPeerId}).then(function(){var r=p()(s.a.mark((function r(t){return s.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.resume();case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}()));case 1:case"end":return t.stop()}}),t)})))()},startStream:function(){var e=this;return p()(s.a.mark((function r(){return s.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:e.getDevices().then(function(){var r=p()(s.a.mark((function r(t){return s.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(e.sendTransport){r.next=10;break}return r.next=3,e.createTransport("send");case 3:return e.sendTransport=r.sent,r.next=6,e.sendTransport.produce({track:e.localCam.getVideoTracks()[0],encodings:e.camEncodings,appData:{mediaTag:"cam-video"}});case 6:return e.camVideoProducer=r.sent,r.next=9,e.sendTransport.produce({track:e.localCam.getAudioTracks()[0],appData:{mediaTag:"cam-audio"}});case 9:e.camAudioProducer=r.sent;case 10:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}());case 1:case"end":return r.stop()}}),r)})))()},createTransport:function(e){var r=this;return p()(s.a.mark((function t(){return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,r.$peerhost.post("create-transport",{peerId:r.myPeerId,direction:e}).then(function(){var t=p()(s.a.mark((function t(n){var a,c;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(c=n.data.transportOptions,"recv"!==e){t.next=7;break}return t.next=4,r.device.createRecvTransport(c);case 4:a=t.sent,t.next=14;break;case 7:if("send"!==e){t.next=13;break}return t.next=10,r.device.createSendTransport(c);case 10:a=t.sent,t.next=14;break;case 13:throw new Error("bad transport 'direction': ".concat(e));case 14:return a.on("connect",function(){var t=p()(s.a.mark((function t(n,a,o){var i;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:i=n.dtlsParameters,console.log("transport is connecting at: ",e),r.$peerhost.post("connect-transport",{transportId:c.id,dtlsParameters:i,peerId:r.myPeerId}).then((function(r){var t=r.data.error;if(t)return err("error connecting transport",e,t),void o();a()}));case 3:case"end":return t.stop()}}),t)})));return function(e,r,n){return t.apply(this,arguments)}}()),"send"===e&&(!1,a.on("produce",function(){var e=p()(s.a.mark((function e(t,n,a){var o,i,u;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=t.kind,i=t.rtpParameters,u=t.appData,console.log("firing produce transport event",u),r.$peerhost.post("send-track",{peerId:r.myPeerId,transportId:c.id,kind:o,rtpParameters:i,paused:!1,appData:u}).then((function(e){var r=e.data,t=r.error,c=r.id;if(t)return err("error setting up server-side producer",t),void a();n({id:c})}));case 3:case"end":return e.stop()}}),e)})));return function(r,t,n){return e.apply(this,arguments)}}())),a.on("connectionstatechange",function(){var e=p()(s.a.mark((function e(r){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("transport ".concat(a.id," connectionstatechange ").concat(r));case 1:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}()),t.abrupt("return",a);case 18:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}());case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})))()},uuidv4:function(){return"111-111-1111".replace(/[018]/g,(function(){return(15&crypto.getRandomValues(new Uint8Array(1))[0]).toString(16)}))},loadDevice:function(){console.log("starting up ... my peerId is ".concat(this.myPeerId));try{this.device=new d.Device}catch(e){if("UnsupportedError"===e.name)return void console.error("browser not supported for video calls");console.error(e)}console.log(this.device),window.addEventListener("unload",(function(){return sig("leave",{},!0)}))},startSync:function(){var e=this;return p()(s.a.mark((function r(){return s.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",e.$peerhost.post("is-sync",{peerId:e.myPeerId}).then((function(r){var t=r.data,n=t.peers,a=t.activeSpeaker,c=t.error;if(c)return{error:c};e.currentActiveSpeaker=a;e.sortPeers(n),e.sortPeers(e.lastPollSyncData);var s=function(r){n[r]||(log("peer ".concat(r," has exited")),e.consumers.forEach((function(e){e.appData.peerId})))};for(var o in e.lastPollSyncData)s(o);return e.consumers.forEach((function(e){var r=e.appData,t=r.peerId,a=r.mediaTag;n[t].media[a]||log("peer ".concat(t," has stopped transmitting ").concat(a))})),e.lastPollSyncData=n,{}})));case 1:case"end":return r.stop()}}),r)})))()},updatePeersDisplay:function(e,r){},getDevices:function(){var e=this;return p()(s.a.mark((function r(){return s.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!e.localCam){r.next=2;break}return r.abrupt("return");case 2:return r.prev=2,r.next=5,navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then((function(r){return e.localCam=r,r}));case 5:return r.abrupt("return",r.sent);case 8:r.prev=8,r.t0=r.catch(2),console.error("start camera error",r.t0);case 11:case"end":return r.stop()}}),r,null,[[2,8]])})))()},sortPeers:function(e){return Object.entries(e).map((function(e){var r=a()(e,2),t=r[0],n=r[1];return{id:t,joinTs:n.joinTs,media:f({},n.media)}})).sort((function(e,r){return e.joinTs>r.joinTs?1:r.joinTs>e.joinTs?-1:0}))},sleep:function(e){return p()(s.a.mark((function r(){return s.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",new Promise((function(r){return setTimeout((function(){return r()}),e)})));case 1:case"end":return r.stop()}}),r)})))()}},mounted:function(){var e=this;this.loadDevice(),this.$peerhost.post("join-peer",{peerId:this.myPeerId}).then((function(r){var t=r.data.routerRtpCapabilities;e.device.loaded||e.device.load({routerRtpCapabilities:t}).then((function(r){var t=setInterval(p()(s.a.mark((function r(){var n,a;return s.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.startSync();case 2:n=r.sent,(a=n.error)&&(clearInterval(t),console.log(a,"@error on pll"));case 5:case"end":return r.stop()}}),r)}))),3e3)}))}))}},m=t("2877"),h=Object(m.a)(v,(function(){var e=this.$createElement,r=this._self._c||e;return r("q-page",[r("div",{staticStyle:{width:"100%","max-height":"100%"}},[r("q-btn",{attrs:{label:"send video stream"},on:{click:this.startStream}}),r("div",{staticClass:"row",staticStyle:{width:"100%"}},[r("div",{staticClass:"col-sm-10 videos "},this._l(this.consumers,(function(e,t){return r("video",{key:t,staticStyle:{width:"250px",height:"250px"},attrs:{autoplay:""},domProps:{srcObject:e.srcObject}})})),0),r("div",{staticClass:"col-sm-6"},[r("pre",{staticStyle:{"max-height":"560px",overflow:"auto"}},[this._v("          "+this._s(this.recvTransport)+"\n        ")])])])],1)])}),[],!1,null,null,null);r.default=h.exports}}]);